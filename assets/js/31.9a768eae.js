(window.webpackJsonp=window.webpackJsonp||[]).push([[31],{385:function(a,t,s){"use strict";s.r(t);var e=s(43),_=Object(e.a)({},(function(){var a=this,t=a.$createElement,s=a._self._c||t;return s("ContentSlotsDistributor",{attrs:{"slot-key":a.$parent.slotKey}},[s("h1",{attrs:{id:"docker-gitlab-备份还原"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#docker-gitlab-备份还原"}},[a._v("#")]),a._v(" docker gitlab 备份还原")]),a._v(" "),s("h2",{attrs:{id:"灾难起源"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#灾难起源"}},[a._v("#")]),a._v(" 灾难起源")]),a._v(" "),s("p",[a._v("起因是服务器 "),s("code",[a._v("root")]),a._v(" 文件系统内存较小，只有 "),s("code",[a._v("50G")]),a._v("，经常爆仓。"),s("br"),a._v("\n于是乎，就把 "),s("code",[a._v("gitlab")]),a._v(" 整体移动到内存相对较大 "),s("code",[a._v("home")]),a._v(" 文件系统下。"),s("br"),a._v("\n这不，转移了，我人直接裂开来。")]),a._v(" "),s("h3",{attrs:{id:"噩耗！！！"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#噩耗！！！"}},[a._v("#")]),a._v(" 噩耗！！！")]),a._v(" "),s("p",[a._v("我打开命令窗口，口嚼香糖，一顿蜻蜓点水，在键盘上滑过 "),s("code",[a._v("cp -R /app /home")]),a._v("，刹那间，整整几个 "),s("code",[a._v("G")]),a._v(" 的文件便搬了家。当然，其中包含着这个星期来所备份的文件。")]),a._v(" "),s("p",[a._v("然而，此时的我仍然在享受着香糖在口腔带来的愉悦，却不知下一秒，"),s("code",[a._v("gitlab")]),a._v(" 的明天与意外哪个会先来。")]),a._v(" "),s("p",[a._v("我对着 "),s("code",[a._v("gitlab")]),a._v(" 满心许下祝福，轻轻地敲下：")]),a._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[a._v("$ cd /home/app/docker/gitlab\n$ docker-compose up\n")])])]),s("p",[a._v("而此刻，等待我的却是，无尽的无尽。")]),a._v(" "),s("p",[s("img",{attrs:{src:"/docker/docker_gitlab_restore/01.png",alt:"gitaly cant up"}})]),a._v(" "),s("p",[a._v("有个 "),s("code",[a._v("gitaly")]),a._v(" 服务启动失败！")]),a._v(" "),s("h3",{attrs:{id:"失格！！！"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#失格！！！"}},[a._v("#")]),a._v(" 失格！！！")]),a._v(" "),s("p",[a._v("啊，这……")]),a._v(" "),s("p",[a._v("在重新尝试多次启动无果后，似乎走上了一条不归路。"),s("br"),a._v("\n漆黑的命令窗口，如同深渊，凝视着你的凝视。")]),a._v(" "),s("p",[a._v("随着：")]),a._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[a._v("$ docker "),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("rm")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token variable"}},[s("span",{pre:!0,attrs:{class:"token variable"}},[a._v("`")]),a._v("docker "),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("ps")]),a._v(" -a "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("|")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("grep")]),a._v(" Exited "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("|")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("awk")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v("'{print "),s("span",{pre:!0,attrs:{class:"token variable"}},[a._v("$1")]),a._v("}'")]),s("span",{pre:!0,attrs:{class:"token variable"}},[a._v("`")])]),a._v("  \n$ docker rmi -f "),s("span",{pre:!0,attrs:{class:"token variable"}},[s("span",{pre:!0,attrs:{class:"token variable"}},[a._v("`")]),a._v("docker images "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("|")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("grep")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v("'<none>'")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("|")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("awk")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v("'{print "),s("span",{pre:!0,attrs:{class:"token variable"}},[a._v("$3")]),a._v("}'")]),s("span",{pre:!0,attrs:{class:"token variable"}},[a._v("`")])]),a._v("  \n")])])]),s("p",[a._v("命令的执行，似乎变得清净起来。"),s("br"),a._v("\n清除了停止的容器与无用的镜像。干净的环境，总会为 "),s("code",[a._v("gitlab")]),a._v(" 带来好运吧。然而，到头来还是一场梦。")]),a._v(" "),s("p",[a._v("依然启动不了 "),s("code",[a._v("gitaly")]),a._v(" 服务，而带来的后果，就是仓库页面数据读取的失败。")]),a._v(" "),s("p",[s("img",{attrs:{src:"/docker/docker_gitlab_restore/02.png",alt:"gitlab 503"}})]),a._v(" "),s("p",[a._v("其他页面功能正常，仓库页面访问返回 "),s("code",[a._v("503")]),a._v("。")]),a._v(" "),s("h3",{attrs:{id:"返璞！！！"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#返璞！！！"}},[a._v("#")]),a._v(" 返璞！！！")]),a._v(" "),s("p",[a._v("既然是转移之后出现的错误，那我再转移回来会报错吗？")]),a._v(" "),s("p",[a._v("随着我把命令喂给窗口后，"),s("code",[a._v("gitlab")]),a._v(" 回到了原本属于它的家乡。正如同古诗句“乡音无改鬓毛衰”，此刻的 "),s("code",[a._v("gitlab")]),a._v(" 与 它生长的 "),s("code",[a._v("/app")]),a._v(" 环境却那么的格格不入。")]),a._v(" "),s("p",[a._v("依然是启动不了 "),s("code",[a._v("gitaly")]),a._v("，那么，"),s("code",[a._v("gitaly")]),a._v(" 启动失败跟仓库页面 "),s("code",[a._v("503")]),a._v(" 有什么关系呢？")]),a._v(" "),s("blockquote",[s("p",[a._v("Gitaly 是一个 Git RPC\n服务，用于处理 GitLab 进行的所有 git 调用。"),s("br"),a._v("\n后台服务，专门负责访问磁盘以高效处理 git 操作，并缓存耗时操作。所有 git 操作都通过 Gitaly 处理。")])]),a._v(" "),s("p",[a._v("即是 "),s("code",[a._v("gitaly")]),a._v(" 是 "),s("code",[a._v("gitlab")]),a._v(" 使用的处理读取 "),s("code",[a._v("git")]),a._v(" 的桥梁服务，"),s("code",[a._v("gitaly")]),a._v(" 开不起来，那么 "),s("code",[a._v("gitlab")]),a._v(" 的 "),s("code",[a._v("git")]),a._v(" 仓库数据的读取便是失了效。")]),a._v(" "),s("h3",{attrs:{id:"归真！！！"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#归真！！！"}},[a._v("#")]),a._v(" 归真！！！")]),a._v(" "),s("p",[a._v("经过一番查找，定位问题为数据卷挂载目录下 "),s("code",[a._v("/app/volumes/gitlab/gitlab/repositoies/")]),a._v(" 这个文件夹。")]),a._v(" "),s("p",[a._v("执行 "),s("code",[a._v("ls")]),a._v("，列出目录下文件：")]),a._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[a._v("+gitaly @hashed  @pools\n")])])]),s("p",[a._v("有三个文件，试着把 "),s("code",[a._v("+gitaly")]),a._v(" 文件夹删掉，重新启动 "),s("code",[a._v("docker gitlab")]),a._v("，发现会重新生成 "),s("code",[a._v("+gitaly")]),a._v(" 文件夹，此时的 "),s("code",[a._v("gitlab")]),a._v("，好像一个捉迷藏玩的很好的孩子，藏了很久终于被发现了一样。")]),a._v(" "),s("p",[a._v("仓库页面已经可以打开了，除了代码仓库显示为空仓库，其他数据也可以读取了。")]),a._v(" "),s("p",[s("img",{attrs:{src:"/docker/docker_gitlab_restore/03.png",alt:"空仓库"}})]),a._v(" "),s("p",[a._v("执行 "),s("code",[a._v("ls -a")]),a._v("，大家都摊牌，别藏着掖着了：")]),a._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[a._v("$ "),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("ls")]),a._v(" -a\n+gitaly .gitaly-metadata  @hashed  @pools\n")])])]),s("p",[a._v("发现有一个隐藏的文件 "),s("code",[a._v(".gitaly-metadata")]),a._v("，查看 "),s("code",[a._v("cat .gitaly-metadata")]),a._v("：")]),a._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[a._v('{"gitaly_filesystem_id":"c19d98bb-9bf7-4579-b120-c6e33902c225"}\n')])])]),s("p",[a._v("估计就是这个生成的配置文件系统 "),s("code",[a._v("ID")]),a._v(" 指向失效了，导致找不到 "),s("code",[a._v("git")]),a._v(" 仓库地址。")]),a._v(" "),s("p",[a._v("尝试过去查找 "),s("code",[a._v("gitaly_filesystem_id")]),a._v(" 的意义，发现源码是 "),s("code",[a._v("ruby")]),a._v(" 函数生成，精力有限，遂无深究。")]),a._v(" "),s("h2",{attrs:{id:"人祸湮灭"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#人祸湮灭"}},[a._v("#")]),a._v(" 人祸湮灭")]),a._v(" "),s("h3",{attrs:{id:"时间旅行"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#时间旅行"}},[a._v("#")]),a._v(" 时间旅行")]),a._v(" "),s("p",[a._v("没错，就是恢复备份。")]),a._v(" "),s("p",[a._v("执行：")]),a._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[a._v("$ "),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[a._v("cd")]),a._v(" /app/docker/gitlab\n$ docker-compose run --rm gitlab app:rake gitlab:backup:restore\n")])])]),s("p",[a._v("执行中，会让选择恢复的备份文件，输入备份 "),s("code",[a._v("tar")]),a._v(" 包完整名称，回车即可。"),s("br"),a._v("\n如："),s("code",[a._v("1593450065_2020_06_29_13.0.6_gitlab_backup.tar")])]),a._v(" "),s("p",[a._v("但是，很不幸，出现权限问题。")]),a._v(" "),s("p",[s("img",{attrs:{src:"/docker/docker_gitlab_restore/04.png",alt:"还原出现权限问题"}}),a._v(" "),s("img",{attrs:{src:"/docker/docker_gitlab_restore/05.png",alt:"还原失败"}})]),a._v(" "),s("h3",{attrs:{id:"精准夺权"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#精准夺权"}},[a._v("#")]),a._v(" 精准夺权")]),a._v(" "),s("p",[a._v("遇到阻碍，那就夺权。")]),a._v(" "),s("p",[a._v("目标是备份文件 "),s("code",[a._v("tar")]),a._v(" 包下所有文件的用户组与所有者，都修改为 "),s("code",[a._v("root")]),a._v(" 用户。")]),a._v(" "),s("p",[a._v("把备份文件 "),s("code",[a._v("tar")]),a._v(" 包拖出来，解压到 "),s("code",[a._v("backup")]),a._v(" 文件夹，修改权限到 "),s("code",[a._v("root")]),a._v(" 用户组与 "),s("code",[a._v("root")]),a._v(" 所有者。")]),a._v(" "),s("p",[s("img",{attrs:{src:"/docker/docker_gitlab_restore/06.png",alt:"备份文件解压"}})]),a._v(" "),s("p",[a._v("修改 "),s("code",[a._v("backup")]),a._v(" 文件夹里面所有文件为用户组 "),s("code",[a._v("root")])]),a._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[s("span",{pre:!0,attrs:{class:"token function"}},[a._v("chgrp")]),a._v(" -R root backup\n")])])]),s("p",[a._v("修改 "),s("code",[a._v("backup")]),a._v(" 文件夹里面所有文件为所有者 "),s("code",[a._v("root")])]),a._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[s("span",{pre:!0,attrs:{class:"token function"}},[a._v("chown")]),a._v(" -R root backup\n")])])]),s("p",[a._v("然后将夺权后的文件再重新打包为 "),s("code",[a._v("tar")]),a._v(" 包。")]),a._v(" "),s("p",[a._v("继续执行：")]),a._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[a._v("$ "),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[a._v("cd")]),a._v(" /app/docker/gitlab\n$ docker-compose run --rm gitlab app:rake gitlab:backup:restore\n")])])]),s("p",[s("img",{attrs:{src:"/docker/docker_gitlab_restore/07.png",alt:"还原过程"}})]),a._v(" "),s("p",[a._v("虽然还有报权限错误，因为 "),s("code",[a._v("tar.gz")]),a._v(" 包里面没有夺权，但是问题不大。")]),a._v(" "),s("h3",{attrs:{id:"柳暗花明"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#柳暗花明"}},[a._v("#")]),a._v(" 柳暗花明")]),a._v(" "),s("p",[a._v("回到 "),s("code",[a._v("docker-compose.yml")]),a._v(" 目录，启动容器！")]),a._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[a._v("$ "),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[a._v("cd")]),a._v(" /app/docker/gitlab\n$ docker-compose up\n")])])]),s("p",[a._v("柳暗花明又一村，我胡汉三又回来了！")]),a._v(" "),s("p",[s("img",{attrs:{src:"/docker/docker_gitlab_restore/08.png",alt:"启动成功"}})])])}),[],!1,null,null,null);t.default=_.exports}}]);