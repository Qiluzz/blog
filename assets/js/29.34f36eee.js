(window.webpackJsonp=window.webpackJsonp||[]).push([[29],{380:function(t,a,s){"use strict";s.r(a);var e=s(43),n=Object(e.a)({},(function(){var t=this,a=t.$createElement,s=t._self._c||a;return s("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[s("h1",{attrs:{id:"docker-访问宿主机的-ip-配置问题"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#docker-访问宿主机的-ip-配置问题"}},[t._v("#")]),t._v(" docker 访问宿主机的 ip 配置问题")]),t._v(" "),s("h2",{attrs:{id:"场景描述"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#场景描述"}},[t._v("#")]),t._v(" 场景描述")]),t._v(" "),s("p",[t._v("在 "),s("code",[t._v("centos7")]),t._v(" 运行 "),s("code",[t._v("docker")]),t._v(" 容器应用时，需要连接宿主机的 "),s("code",[t._v("mysql")]),t._v(" 的 "),s("code",[t._v("3306")]),t._v(" 端口，发现连接不上，"),s("code",[t._v("docker")]),t._v(" 容器无法访问宿主机的 "),s("code",[t._v("mysql")]),t._v(" 数据库。但是，在容器内访问外部网络是可以 "),s("code",[t._v("ping")]),t._v(" 通的。")]),t._v(" "),s("h2",{attrs:{id:"原因分析"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#原因分析"}},[t._v("#")]),t._v(" 原因分析")]),t._v(" "),s("p",[t._v("在 "),s("code",[t._v("centos7")]),t._v(" 上部署 "),s("code",[t._v("docker")]),t._v(" 容器，其网络模式采用的是 "),s("code",[t._v("bridge")]),t._v(" 模式。"),s("br"),t._v("\n启动 "),s("code",[t._v("docker")]),t._v(" 时，"),s("code",[t._v("docker")]),t._v(" 进程会创建一个名为 "),s("code",[t._v("docker0")]),t._v(" 的虚拟网桥，用于宿主机与容器之间的通信。当启动一个 "),s("code",[t._v("docker")]),t._v(" 容器时，"),s("code",[t._v("docker")]),t._v(" 容器将会附加到虚拟网桥上，容器内的报文通过 "),s("code",[t._v("docker0")]),t._v(" 向外转发。")]),t._v(" "),s("p",[t._v("如果 "),s("code",[t._v("docker")]),t._v(" 容器访问宿主机，那么 "),s("code",[t._v("docker0")]),t._v(" 网桥将报文直接转发到本机，报文的源地址是 "),s("code",[t._v("docker0")]),t._v(" 网段的地址。而如果 "),s("code",[t._v("docker")]),t._v(" 容器访问宿主机以外的机器，"),s("code",[t._v("docker")]),t._v(" 的 "),s("code",[t._v("SNAT")]),t._v(" 网桥会将报文的源地址转换为宿主机的地址，通过宿主机的网卡向外发送。")]),t._v(" "),s("p",[t._v("因此，当 "),s("code",[t._v("docker")]),t._v(" 容器访问宿主机时，如果宿主机服务端口会被防火墙拦截，那么就无法连通宿主机，出现 "),s("code",[t._v("No route to host")]),t._v(" 的错误。")]),t._v(" "),s("p",[t._v("而访问宿主机所在局域网内的其他机器，由于报文的源地址是宿主机 "),s("code",[t._v("ip")]),t._v("，因此，不会被目的机器防火墙拦截，所以可以访问。")]),t._v(" "),s("h2",{attrs:{id:"解决问题"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#解决问题"}},[t._v("#")]),t._v(" 解决问题")]),t._v(" "),s("p",[t._v("首先设置了 "),s("code",[t._v("mysql")]),t._v(" 的配置文件，保证 "),s("code",[t._v("mysql")]),t._v(" 可以被任何 "),s("code",[t._v("ip")]),t._v(" 访问：")]),t._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("mysqld"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\nbind-address "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0.0")]),t._v(".0.0\n")])])]),s("p",[t._v("修改完配置文件重启生效。"),s("br"),t._v("\n但为了安全考虑，防火墙的 "),s("code",[t._v("3306")]),t._v(" 端口仍然是不开放外网访问的。")]),t._v(" "),s("p",[t._v("容器访问宿主机的地址使用 "),s("code",[t._v("eth0")]),t._v(" 的地址，即宿主机内网 "),s("code",[t._v("ip")]),t._v(" 地址。"),s("br"),t._v("\n运行 "),s("code",[t._v("ipconfig")]),t._v(" 命令，查看网络的虚拟网桥相关信息。")]),t._v(" "),s("p",[t._v("注意：宿主机会把容器 "),s("code",[t._v("ip")]),t._v(" 地址段当成外网 "),s("code",[t._v("ip")]),t._v("。（当前说明是 "),s("code",[t._v("centos7")]),t._v(" 环境）")]),t._v(" "),s("p",[t._v("编辑防火墙文件 "),s("code",[t._v("/etc/firewalld/zones/public.xml")]),t._v("，添加下面 "),s("code",[t._v("docker0")]),t._v(" 地址段到配置：")]),t._v(" "),s("div",{staticClass:"language-xml extra-class"},[s("pre",{pre:!0,attrs:{class:"language-xml"}},[s("code",[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("rule")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token attr-name"}},[t._v("family")]),s("span",{pre:!0,attrs:{class:"token attr-value"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')]),t._v("ipv4"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')])]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("source")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token attr-name"}},[t._v("address")]),s("span",{pre:!0,attrs:{class:"token attr-value"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')]),t._v("172.18.0.0/16"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')])]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("/>")])]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("accept")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("/>")])]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("</")]),t._v("rule")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n")])])]),s("p",[t._v("重启防火墙，"),s("code",[t._v("docker")]),t._v(" 容器即可正常访问宿主机端口。")]),t._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[s("span",{pre:!0,attrs:{class:"token function"}},[t._v("service")]),t._v(" firewalld restart\n")])])]),s("p",[t._v("🎨 如果有用到 "),s("code",[t._v("docker-compose")]),t._v(" 命令，则会自动创建一个名为 "),s("code",[t._v('br-"docker network id"')]),t._v(" 的虚拟网桥。"),s("br"),t._v("\n🎨 此时同样需要将虚拟网桥地址段配置到防火墙白名单，才能正常访问，添加配置：")]),t._v(" "),s("div",{staticClass:"language-xml extra-class"},[s("pre",{pre:!0,attrs:{class:"language-xml"}},[s("code",[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("rule")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token attr-name"}},[t._v("family")]),s("span",{pre:!0,attrs:{class:"token attr-value"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')]),t._v("ipv4"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')])]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("source")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token attr-name"}},[t._v("address")]),s("span",{pre:!0,attrs:{class:"token attr-value"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')]),t._v("172.20.0.0/16"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')])]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("/>")])]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("accept")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("/>")])]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("</")]),t._v("rule")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n")])])]),s("p",[s("img",{attrs:{src:"/docker/docker_call_host/container_connect_host.png",alt:"image"}})]),t._v(" "),s("h2",{attrs:{id:"测试端口"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#测试端口"}},[t._v("#")]),t._v(" 测试端口")]),t._v(" "),s("p",[t._v("在容器中测试宿主机端口是否可以连接，可以使用 "),s("code",[t._v("wget 内网ip:端口")]),t._v(" 命令。")]),t._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[t._v("$ "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("wget")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("172.17")]),t._v(".25.162:3306  \nwget: can not connect to remote "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("host")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("172.17")]),t._v(".25.162"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(": Host is unreachable  "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#不可以连接")]),t._v("\n\n$ "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("wget")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("172.17")]),t._v(".25.162:3306\nwget: bad header line: "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("5.7")]),t._v(".29-log  "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#可以连接")]),t._v("\n")])])])])}),[],!1,null,null,null);a.default=n.exports}}]);